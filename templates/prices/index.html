{% extends "base.html" %}

{% block title %}デモ{% endblock %}

{% block extra_css %}
{#<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.0.0/css/tabulator.min.css" rel="stylesheet">#}
<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.3/css/tabulator.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row justify-content-center my-3">
    <div class="col-10">
        <div id="prices-table"></div>
    </div>
</div>
<div class="row justify-content-center my-3">
    <div class="col-10">
        <input type="button" id="download" class="btn btn-primary" value="CSVダウンロード">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
{#    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.0.0/js/tabulator.min.js"></script>#}
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.3/js/tabulator.min.js"></script>

<script type="text/javascript">
    // 独自 formatter を定義
    Tabulator.extendExtension("format", "formatters", {
        date: function (cell, formatterParams) {
            return moment(cell.getValue()).format("YYYY/MM/DD");
        },
        percent: function (cell, formatterParams) {
            return (cell.getValue() * 100).toFixed(2) + "%";
        },
    });
    // テーブルの初期化
    $("#prices-table").tabulator({
        layout: "fitColumns",
        pagination: "local",
        // 1ページあたり表示件数
        paginationSize: 10,
        // 初回ソート条件
        initialSort: [
            {column: "Date", dir: "desc"},
        ],
        columns: [
            {
                title: "日付<br>(日本時間)",
                field: "Date",
                downloadTitle: "Date",
                sorter: "string",
                formatter: "date"
            },
            {
                title: "通貨",
                field: "Symbol",
                width: "12%",
                sorter: "string"
            },
            {
                title: "価格 (ドル)",
                field: "Price (USD)",
                sorter: "number",
                align: "right",
                formatter: "money",
                formatterParams: {precision: 2, symbol: "$"}
            },
            {
                title: "ドル/円",
                field: "USD/JPY",
                sorter: "number",
                align: "right",
                formatter: "money",
                formatterParams: {precision: 2, symbol: "¥"}
            },
            {
                title: "価格 (円)",
                field: "Price (JPY)",
                sorter: "number",
                align: "right",
                formatter: "money",
                formatterParams: {precision: 0, symbol: "¥"}
            },
            {
                title: "円価格上昇率<br>(％)",
                field: "Price diff rate",
                sorter: "number",
                align: "right",
                formatter: "percent"
            }
        ],
        // 行の色分け
        rowFormatter: function (row) {
            var data = row.getData();
            if (data["Price diff rate"] >= 0) {
                row.getElement().css({"background-color": "#f0fff0"});
            } else {
                row.getElement().css({"background-color": "#fff0f5"});
            }
        },
        locale: true,
        langs: {
            "ja": {
                // ページング部品のラベル名を変更
                "pagination": {
                    "first": "|<",
                    "last": ">|",
                    "prev": "<",
                    "next": ">"
                }
            }
        }
    });

    // 画面表示後に非同期でデータ更新
    $("#prices-table").tabulator("setData", "{% url 'prices:price_history_ajax' %}");

    // CSV ダウンロード
    $("#download").click(function () {
        $("#prices-table").tabulator("download", "csv", "data.csv");
    });
</script>
{% endblock %}
